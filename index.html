<!DOCTYPE html>
<html lang="ro">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      width: 14%;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    .doy0 {
      background-color: lightyellow;
    }

    .doy1 {
      background-color: lightyellow;
    }

    .doy2 {
      background-color: #aaffaa;
    }

    .doy3 {
      background-color: #aaaaff;
    }

    .year-btn {
      padding: 5px 10px;
      margin: 0 5px;
      cursor: pointer;
    }

    .year-btn.active {
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
    }

    .controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .holiday-buttons {
      margin: 10px 0;
      text-align: center;
    }

    .holiday-btn {
      padding: 8px 15px;
      margin: 0 5px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .holiday-btn:hover {
      background-color: #e0e0e0;
    }

    .holiday-result {
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      color: #5555aa;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      min-height: 20px;
    }

    /* Feedback Button Styles */
    .feedback-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 1000;
    }

    .feedback-btn:hover {
      background-color: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border: none;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .feedback-form {
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .submit-btn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }

    .submit-btn:hover {
      background-color: #45a049;
    }

    .submit-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .success-message {
      color: #4CAF50;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }

    .error-message {
      color: #f44336;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="controls">
    <div id="yearButtons"></div>
    <select id="monthSelect"></select>
  </div>
  <div class="holiday-buttons">
    <button id="paste-btn" class="holiday-btn" onclick="checkHolidayPaste()">Pa»ôte</button>
    <button id="craciun-btn" class="holiday-btn" onclick="checkHolidayCraciun()">CrƒÉciun</button>
    <button id="revelion-btn" class="holiday-btn" onclick="checkHolidayRevelion()">Revelion</button>
  </div>
  <div id="holidayResult" class="holiday-result"></div>
  <div id="calendarContainer"></div>

  <!-- Feedback Button -->
  <button class="feedback-btn" onclick="openFeedbackModal()">üìù Feedback</button>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFeedbackModal()">&times;</span>
      <h2>üìù Trimite Feedback Anonim</h2>
      <p>Feedback-ul tƒÉu ne ajutƒÉ sƒÉ √ÆmbunƒÉtƒÉ»õim aplica»õia. Toate mesajele sunt complet anonime.</p>
      
      <form class="feedback-form" id="feedbackForm">
        <div class="form-group">
          <label for="feedbackType">Tipul feedback-ului:</label>
          <select id="feedbackType" name="feedback_type" required>
            <option value="">SelecteazƒÉ tipul...</option>
            <option value="Bug Report">üêõ Raportare Bug</option>
            <option value="Feature Request">üí° Cerere Func»õionalitate NouƒÉ</option>
            <option value="UI/UX Improvement">üé® √émbunƒÉtƒÉ»õire Interfa»õƒÉ</option>
            <option value="General Feedback">üí¨ Feedback General</option>
            <option value="Performance Issue">‚ö° ProblemƒÉ Performan»õƒÉ</option>
          </select>
        </div>

        <div class="form-group">
          <label for="feedbackMessage">Mesajul tƒÉu:</label>
          <textarea 
            id="feedbackMessage" 
            name="message" 
            placeholder="Descrie problema, sugestia sau feedback-ul tƒÉu aici..."
            required
            maxlength="1000"
          ></textarea>
          <small style="color: #666; font-size: 12px;">Maximum 1000 caractere</small>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          Trimite Feedback
        </button>

        <div id="feedbackStatus"></div>
      </form>
    </div>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/emailjs-com/3.2.0/email.min.js"></script>
  
  <script>
    // Initialize EmailJS - YOU NEED TO REPLACE '89U3M7dTOx_Yewv3X' with your actual EmailJS public key
    (function() {
      emailjs.init('89U3M7dTOx_Yewv3X'); // Replace with your EmailJS public key
    })();

    // Your existing calendar code
    const monthSelect = document.getElementById('monthSelect');
    const yearButtonsContainer = document.getElementById('yearButtons');
    const monthNamesRo = [
      "ianuarie", "februarie", "martie", "aprilie",
      "mai", "iunie", "iulie", "august",
      "septembrie", "octombrie", "noiembrie", "decembrie"
    ];
    let currentYear = new Date().getFullYear();
    let selectedYear = currentYear;
    let selectedMonth = new Date().getMonth();

    function createYearButtons() {
      yearButtonsContainer.innerHTML = '';
      for (let year = currentYear - 1; year <= currentYear + 2; year++) {
        const button = document.createElement('button');
        button.className = 'year-btn';
        if (year === selectedYear) {
          button.classList.add('active');
        }
        button.textContent = year;
        button.onclick = function() {
          selectedYear = year;
          saveToLocalStorage();
          updateYearButtons();
          updateCalendar();
        };
        yearButtonsContainer.appendChild(button);
      }
    }

    function updateYearButtons() {
      const buttons = yearButtonsContainer.querySelectorAll('.year-btn');
      buttons.forEach(button => {
        if (parseInt(button.textContent) === selectedYear) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    function populateMonthSelect() {
      monthSelect.innerHTML = '';
      for (let month = 0; month < 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = monthNamesRo[month];
        if (month === selectedMonth) {
          option.selected = true;
        }
        monthSelect.appendChild(option);
      }
    }

    function loadFromLocalStorage() {
      const storedYear = localStorage.getItem('selectedYear');
      const storedMonth = localStorage.getItem('selectedMonth');
      if (storedYear) {
        selectedYear = parseInt(storedYear);
      }
      if (storedMonth) {
        selectedMonth = parseInt(storedMonth);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('selectedYear', selectedYear);
      localStorage.setItem('selectedMonth', selectedMonth);
    }

    function initializeControls() {
      loadFromLocalStorage();
      createYearButtons();
      populateMonthSelect();
      monthSelect.addEventListener('change', function() {
        selectedMonth = parseInt(monthSelect.value);
        saveToLocalStorage();
        updateCalendar();
      });
    }

    function updateCalendar() {
      const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
      const firstDay = (new Date(selectedYear, selectedMonth, 1).getDay() + 6) % 7;
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let tura = 4;
      if (urlParams.has("tura")) {
        const turaValue = urlParams.get("tura");
        tura = parseInt(turaValue);
      }
      if (urlParams.has("user")) {
        const userValue = urlParams.get("user");
        const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
        for (let i = 0; i < users.length; i++) {
          if (users[i] === userValue) {
            tura = i + 1;
            break;
          }
        }
      }
      if (tura % 2 === 0) tura = 6 - tura;
      const date1 = new Date(selectedYear, selectedMonth, 1);
      const date0 = new Date(2024, 0, 1);
      let fakeDayOfYear = Math.ceil((date1 - date0) / 86400000);
      let calendarHTML = `<table>
                    <tr>
                        <th>lun</th>
                        <th>mar</th>
                        <th>mie</th>
                        <th>joi</th>
                        <th>vin</th>
                        <th>s√¢m</th>
                        <th>dum</th>
                    </tr>
                    <tr>`;
      let dayCount = 1;
      for (let i = 0; i < 42; i++) {
        if (i >= firstDay && dayCount <= daysInMonth) {
          let dt = (fakeDayOfYear + tura) % 4;
          let doyClass = `doy${dt}`;
          calendarHTML += `<td class="${doyClass}">${dayCount}</td>`;
          fakeDayOfYear++;
          dayCount++;
        } else {
          calendarHTML += `<td></td>`;
        }
        if (i % 7 === 6 && dayCount <= daysInMonth) {
          calendarHTML += `</tr><tr>`;
        }
        if (dayCount > daysInMonth && i % 7 === 6) {
          break;
        }
      }
      calendarHTML += `</tr></table>`;
      document.getElementById("calendarContainer").innerHTML = calendarHTML;
    }

    function getTura() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let tura = 4;
      if (urlParams.has("tura")) {
        const turaValue = urlParams.get("tura");
        tura = parseInt(turaValue);
      }
      if (urlParams.has("user")) {
        const userValue = urlParams.get("user");
        const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
        for (let i = 0; i < users.length; i++) {
          if (users[i] === userValue) {
            tura = i + 1;
            break;
          }
        }
      }
      if (tura % 2 === 0) tura = 6 - tura;
      return tura;
    }

    function getEasterDate(year) {
      // Algorithm pentru calcularea Pa»ôtelui Ortodox
      const a = year % 4;
      const b = year % 7;
      const c = year % 19;
      const d = (19 * c + 15) % 30;
      const e = (2 * a + 4 * b - d + 34) % 7;
      const month = Math.floor((d + e + 114) / 31);
      const day = ((d + e + 114) % 31) + 1;
      // Ajustare pentru calendarul Gregorian (Pa»ôtele Ortodox)
      let easterDate = new Date(year, month - 1, day);
      easterDate.setDate(easterDate.getDate() + 13); // Diferen»õa de 13 zile pentru calendarul Iulian
      return easterDate;
    }

    function getDayName(date) {
      const days = ['duminicƒÉ', 'luni', 'mar»õi', 'miercuri', 'joi', 'vineri', 's√¢mbƒÉtƒÉ'];
      return days[date.getDay()];
    }

    function findClosestWorkShift(holidayDate, tura) {
      const date0 = new Date(2024, 0, 1);
      const baseDaysDiff = Math.ceil((holidayDate - date0) / 86400000);
      // CautƒÉ √Æn jurul datei sƒÉrbƒÉtorii pentru cea mai apropiatƒÉ turƒÉ de lucru
      let closestShift = null;
      let minDistance = Infinity;
      for (let offset = -10; offset <= 10; offset++) {
        const checkDate = new Date(holidayDate);
        checkDate.setDate(checkDate.getDate() + offset);
        const daysDiff = Math.ceil((checkDate - date0) / 86400000);
        const shiftType = (daysDiff + tura) % 4;
        // Doar turile de zi (2) »ôi noapte (3)
        if (shiftType === 2 || shiftType === 3) {
          const distance = Math.abs(offset);
          if (distance < minDistance) {
            minDistance = distance;
            closestShift = {
              date: new Date(checkDate),
              shift: shiftType === 2 ? 'de zi' : 'de noapte',
              dayName: getDayName(checkDate)
            };
          }
        }
      }
      return closestShift;
    }

    function checkHolidayPaste() {
      checkHoliday('paste');
    }

    function checkHolidayCraciun() {
      checkHoliday('craciun');
    }

    function checkHolidayRevelion() {
      checkHoliday('revelion');
    }

    const months = ['ianuarie', 'februarie', 'martie', 'aprilie', 'mai', 'iunie',
          'iulie', 'august', 'septembrie', 'octombrie', 'noiembrie', 'decembrie'
        ];

    function checkHoliday(holiday) {
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const tura = getTura();
      let holidayDate, holidayName, targetYear;
      for (let year = currentYear; year <= currentYear + 10; year++) {
        if (holiday === 'paste') {
          holidayDate = getEasterDate(year);
          holidayName = 'Pa»ôte';
        } else if (holiday === 'craciun') {
          holidayDate = new Date(year, 11, 25); // 25 decembrie
          holidayName = 'CrƒÉciun';
        } else if (holiday === 'revelion') {
          holidayDate = new Date(year, 0, 1); // 1 ianuarie
          holidayName = 'Revelion';
        }
        if (holidayDate > currentDate) {
          targetYear = year;
          break;
        }
      }
      const closestWork = findClosestWorkShift(holidayDate, tura);
      let message;
      if (holiday === 'revelion') {
        message = `De ${holidayName} ${targetYear} sunt ${closestWork.shift} ${closestWork.dayName}, ${closestWork.date.getDate()} ${months[closestWork.date.getMonth()]} ${closestWork.date.getFullYear()}`;
      } else {
        const monthName = months[closestWork.date.getMonth()];
        message = `De ${holidayName} ${targetYear} sunt ${closestWork.shift} ${closestWork.dayName}, ${closestWork.date.getDate()} ${monthName} ${closestWork.date.getFullYear()}`;
      }
      document.getElementById('holidayResult').innerHTML = `${
        message
      }`;
    }

    // Feedback Modal Functions
    function openFeedbackModal() {
      document.getElementById('feedbackModal').style.display = 'block';
      // Reset form
      document.getElementById('feedbackForm').reset();
      document.getElementById('feedbackStatus').innerHTML = '';
      document.getElementById('submitBtn').disabled = false;
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('feedbackModal');
      if (event.target === modal) {
        closeFeedbackModal();
      }
    }

    // Handle feedback form submission
    document.getElementById('feedbackForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const statusDiv = document.getElementById('feedbackStatus');
      
      // Disable submit button and show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'Se trimite...';
      statusDiv.innerHTML = '';

      // Get form data
      const formData = {
        feedback_type: document.getElementById('feedbackType').value,
        message: document.getElementById('feedbackMessage').value,
        timestamp: new Date().toLocaleString('ro-RO'),
        user_agent: navigator.userAgent,
        url: window.location.href
      };

      // Send email using EmailJS
      // YOU NEED TO REPLACE 'YOUR_SERVICE_ID' and 'YOUR_TEMPLATE_ID' with your actual EmailJS IDs
      emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
        feedback_type: formData.feedback_type,
        message: formData.message,
        timestamp: formData.timestamp,
        user_agent: formData.user_agent,
        url: formData.url
      })
      .then(function(response) {
        console.log('Feedback sent successfully!', response.status, response.text);
        statusDiv.innerHTML = '<div class="success-message">‚úÖ Feedback trimis cu succes! Mul»õumim!</div>';
        
        // Reset form after success
        setTimeout(() => {
          closeFeedbackModal();
        }, 2000);
        
      }, function(error) {
        console.log('Failed to send feedback...', error);
        statusDiv.innerHTML = '<div class="error-message">‚ùå Eroare la trimiterea feedback-ului. Te rog √ÆncearcƒÉ din nou.</div>';
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Trimite Feedback';
      });
    });

    // Initialize the app
    initializeControls();
    updateCalendar();
  </script>
</body>

</html>