<!DOCTYPE html>
<html lang="ro">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      width: 14%;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    .doy0 {
      background-color: lightyellow;
    }

    .doy1 {
      background-color: lightyellow;
    }

    .doy2 {
      background-color: #aaffaa;
    }

    .doy3 {
      background-color: #aaaaff;
    }

    .year-btn {
      padding: 5px 10px;
      margin: 0 5px;
      cursor: pointer;
    }

    .year-btn.active {
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
    }

    .controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .holiday-buttons {
      margin: 10px 0;
      text-align: center;
    }

    .holiday-btn {
      padding: 8px 15px;
      margin: 0 5px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .holiday-btn:hover {
      background-color: #e0e0e0;
    }

    .holiday-result {
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      color: #5555aa;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      min-height: 20px;
    }
  </style>
</head>

<body>
  <div class="controls">
    <div id="yearButtons"></div>
    <select id="monthSelect"></select>
  </div>
  <div class="holiday-buttons">
    <button id="paste-btn" class="holiday-btn" onclick="checkHolidayPaste()">Paște</button>
    <button id="craciun-btn" class="holiday-btn" onclick="checkHolidayCraciun()">Crăciun</button>
    <button id="revelion-btn" class="holiday-btn" onclick="checkHolidayRevelion()">Revelion</button>
  </div>
  <div id="holidayResult" class="holiday-result"></div>
  <div id="calendarContainer"></div>

  <script>
    const monthSelect = document.getElementById('monthSelect');
    const yearButtonsContainer = document.getElementById('yearButtons');
    const monthNamesRo = [
      "ianuarie", "februarie", "martie", "aprilie",
      "mai", "iunie", "iulie", "august",
      "septembrie", "octombrie", "noiembrie", "decembrie"
    ];
    let currentYear = new Date().getFullYear();
    let selectedYear = currentYear;
    let selectedMonth = new Date().getMonth();

    function createYearButtons() {
      yearButtonsContainer.innerHTML = '';
      for (let year = currentYear - 1; year <= currentYear + 2; year++) {
        const button = document.createElement('button');
        button.className = 'year-btn';
        if (year === selectedYear) {
          button.classList.add('active');
        }
        button.textContent = year;
        button.onclick = function() {
          selectedYear = year;
          saveToLocalStorage();
          updateYearButtons();
          updateCalendar();
        };
        yearButtonsContainer.appendChild(button);
      }
    }

    function updateYearButtons() {
      const buttons = yearButtonsContainer.querySelectorAll('.year-btn');
      buttons.forEach(button => {
        if (parseInt(button.textContent) === selectedYear) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    function populateMonthSelect() {
      monthSelect.innerHTML = '';
      for (let month = 0; month < 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = monthNamesRo[month];
        if (month === selectedMonth) {
          option.selected = true;
        }
        monthSelect.appendChild(option);
      }
    }

    function loadFromLocalStorage() {
      const storedYear = localStorage.getItem('selectedYear');
      const storedMonth = localStorage.getItem('selectedMonth');
      if (storedYear) {
        selectedYear = parseInt(storedYear);
      }
      if (storedMonth) {
        selectedMonth = parseInt(storedMonth);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('selectedYear', selectedYear);
      localStorage.setItem('selectedMonth', selectedMonth);
    }

    function initializeControls() {
      loadFromLocalStorage();
      createYearButtons();
      populateMonthSelect();
      monthSelect.addEventListener('change', function() {
        selectedMonth = parseInt(monthSelect.value);
        saveToLocalStorage();
        updateCalendar();
      });
    }

    function updateCalendar() {
      const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
      const firstDay = (new Date(selectedYear, selectedMonth, 1).getDay() + 6) % 7;
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let tura = 4;
      if (urlParams.has("tura")) {
        const turaValue = urlParams.get("tura");
        tura = parseInt(turaValue);
      }
      if (urlParams.has("user")) {
        const userValue = urlParams.get("user");
        const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
        for (let i = 0; i < users.length; i++) {
          if (users[i] === userValue) {
            tura = i + 1;
            break;
          }
        }
      }
      if (tura % 2 === 0) tura = 6 - tura;
      const date1 = new Date(selectedYear, selectedMonth, 1);
      const date0 = new Date(2024, 0, 1);
      let fakeDayOfYear = Math.ceil((date1 - date0) / 86400000);
      let calendarHTML = `<table>
                    <tr>
                        <th>lun</th>
                        <th>mar</th>
                        <th>mie</th>
                        <th>joi</th>
                        <th>vin</th>
                        <th>sâm</th>
                        <th>dum</th>
                    </tr>
                    <tr>`;
      let dayCount = 1;
      for (let i = 0; i < 42; i++) {
        if (i >= firstDay && dayCount <= daysInMonth) {
          let dt = (fakeDayOfYear + tura) % 4;
          let doyClass = `doy${dt}`;
          calendarHTML += `<td class="${doyClass}">${dayCount}</td>`;
          fakeDayOfYear++;
          dayCount++;
        } else {
          calendarHTML += `<td></td>`;
        }
        if (i % 7 === 6 && dayCount <= daysInMonth) {
          calendarHTML += `</tr><tr>`;
        }
        if (dayCount > daysInMonth && i % 7 === 6) {
          break;
        }
      }
      calendarHTML += `</tr></table>`;
      document.getElementById("calendarContainer").innerHTML = calendarHTML;
    }

    function getTura() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let tura = 4;
      if (urlParams.has("tura")) {
        const turaValue = urlParams.get("tura");
        tura = parseInt(turaValue);
      }
      if (urlParams.has("user")) {
        const userValue = urlParams.get("user");
        const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
        for (let i = 0; i < users.length; i++) {
          if (users[i] === userValue) {
            tura = i + 1;
            break;
          }
        }
      }
      if (tura % 2 === 0) tura = 6 - tura;
      return tura;
    }

    function getEasterDate(year) {
      // Algorithm pentru calcularea Paștelui Ortodox
      const a = year % 4;
      const b = year % 7;
      const c = year % 19;
      const d = (19 * c + 15) % 30;
      const e = (2 * a + 4 * b - d + 34) % 7;
      const month = Math.floor((d + e + 114) / 31);
      const day = ((d + e + 114) % 31) + 1;
      // Ajustare pentru calendarul Gregorian (Paștele Ortodox)
      let easterDate = new Date(year, month - 1, day);
      easterDate.setDate(easterDate.getDate() + 13); // Diferența de 13 zile pentru calendarul Iulian
      return easterDate;
    }

    function getDayName(date) {
      const days = ['duminică', 'luni', 'marți', 'miercuri', 'joi', 'vineri', 'sâmbătă'];
      return days[date.getDay()];
    }

    function findClosestWorkShift(holidayDate, tura) {
      const date0 = new Date(2024, 0, 1);
      const baseDaysDiff = Math.ceil((holidayDate - date0) / 86400000);
      // Caută în jurul datei sărbătorii pentru cea mai apropiată tură de lucru
      let closestShift = null;
      let minDistance = Infinity;
      for (let offset = -10; offset <= 10; offset++) {
        const checkDate = new Date(holidayDate);
        checkDate.setDate(checkDate.getDate() + offset);
        const daysDiff = Math.ceil((checkDate - date0) / 86400000);
        const shiftType = (daysDiff + tura) % 4;
        // Doar turile de zi (2) și noapte (3)
        if (shiftType === 2 || shiftType === 3) {
          const distance = Math.abs(offset);
          if (distance < minDistance) {
            minDistance = distance;
            closestShift = {
              date: new Date(checkDate),
              shift: shiftType === 2 ? 'de zi' : 'de noapte',
              dayName: getDayName(checkDate)
            };
          }
        }
      }
      return closestShift;
    }

    function checkHolidayPaste() {
      checkHoliday('paste');
    }

    function checkHolidayCraciun() {
      checkHoliday('craciun');
    }

    function checkHolidayRevelion() {
      checkHoliday('revelion');
    }

    function checkHoliday(holiday) {
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const tura = getTura();
      let holidayDate, holidayName, targetYear;
      for (let year = currentYear; year <= currentYear + 10; year++) {
        if (holiday === 'paste') {
          holidayDate = getEasterDate(year);
          holidayName = 'Paște';
        } else if (holiday === 'craciun') {
          holidayDate = new Date(year, 11, 25); // 25 decembrie
          holidayName = 'Crăciun';
        } else if (holiday === 'revelion') {
          holidayDate = new Date(year, 11, 31); // 31 decembrie
          holidayName = 'Revelion';
        }
        if (holidayDate > currentDate) {
          targetYear = year;
          break;
        }
      }
      const closestWork = findClosestWorkShift(holidayDate, tura);
      let message;
      if (holiday === 'revelion') {
        message = `De ${holidayName} ${targetYear + 1} sunt ${closestWork.shift} ${closestWork.dayName}, ${closestWork.date.getDate()} decembrie ${closestWork.date.getFullYear()}`;
      } else {
        const months = ['ianuarie', 'februarie', 'martie', 'aprilie', 'mai', 'iunie',
          'iulie', 'august', 'septembrie', 'octombrie', 'noiembrie', 'decembrie'
        ];
        const monthName = months[closestWork.date.getMonth()];
        message = `De ${holidayName} ${targetYear} sunt ${closestWork.shift} ${closestWork.dayName}, ${closestWork.date.getDate()} ${monthName} ${closestWork.date.getFullYear()}`;
      }
      document.getElementById('holidayResult').innerHTML = `${
        message
      }`;
    }
    initializeControls();
    updateCalendar();
  </script>
</body>

</html>